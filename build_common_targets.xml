<?xml version="1.0"?>
<project name="D4M_COMMON_TARGETS" basedir=".">

  <property file="${basedir}/../d4m_api_java/default_build.properties"/>

  <property name="full_property_file_name" value="../d4m_api_java/${property_file_name}" />
  <property name="base_property_file_name" value="../d4m_api_java/base_build.properties" />
  <property file="${full_property_file_name}"/>
  <property file="${base_property_file_name}"/>

  <!-- Directories -->
  <property name="build.dir" value="${basedir}/build"/>
  <property name="lib.dir" value="${basedir}/lib"/>
  <property name="src.dir" value="${basedir}/src"/>
  <property name="test_src.dir"  value="${basedir}/test"/>
  <property name="dist.dir" value="${build.dir}/dist"/>
  <property name="test.reports" value="${basedir}/build/reports"/>
    
  <!-- Attributes -->
  <property name="version.file" value="${basedir}/VERSION.txt"/>
	
  <path id="master_classpath">
     <fileset dir="${lib.dir}">
       <include name="**/*.jar"/>
     </fileset>
     <pathelement path="${build.dir}/classes"/>
     <pathelement path="${dist.dir}/conf"/>
  </path>
       
  <target name="clean">
     <delete dir="${build.dir}"/>
  </target>

  <target name="get_version">
    <copy file="${version.file}" tofile="${build.dir}/dist/VERSION" overwrite="true"/>
    <loadfile srcFile="${version.file}" property="version_number" failonerror="true" encoding="UTF-8">
      <filterchain>       
        <tailfilter lines="1" skip="0"/>
        <tokenfilter>
          <replaceregex pattern=",.*" replace=""/>
          <replaceregex pattern="\z" replace=""/>
        </tokenfilter>
      </filterchain>
    </loadfile>
    <echo message="The version number is: ${version_number}."/>
  </target>
    	
  <target name="init" depends="get_version">
    <mkdir dir="${build.dir}/dist"/>
    <mkdir dir="${build.dir}/dist/docs"/>
    <mkdir dir="${build.dir}/dist/lib"/>
  </target>
      
	<target name="build_distribution" depends="get_version">
         <property name="version.num"  value="1.1.4"/>
          <property name="version.num"  value="${version_number}"/>
		<zip destfile="${build.dir}/${ant.project.name}_${version.num}.zip">
			<zipfileset dir="${build.dir}/dist/bin" filemode="755" prefix="${ant.project.name}_${version.num}/bin/">
				<include name="*.sh"/>
			</zipfileset>

			<zipfileset dir="${build.dir}/dist" prefix="${ant.project.name}_${version.num}">
				<include name="**/**"/>
				<exclude name="**/*.sh"/>
			</zipfileset>

		</zip>
	</target>

  <target name="build_distribution_full" depends="get_version">
    <zip destfile="${build.dir}/${ant.project.name}_${version_number}_full.zip" >
      <zipfileset dir="." prefix="${ant.project.name}">
        <exclude name="**/.svn" />
        <exclude name="**/*CVS" />
        <exclude name="**/.cvsignore" />
        <exclude name="**/bin/" />
        <exclude name="**/build/" />
        <exclude name="**/logs/" />
        <exclude name="**/temp/" />
        <include name="**/*" />
        <include name="*.*" />
      </zipfileset>
    </zip>
  </target>

</project>
